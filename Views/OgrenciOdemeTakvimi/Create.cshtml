@model StudentApp.Models.OgrenciOdemeTakvimi

@{
    ViewData["Title"] = "Ödeme Gir";
    var ogrenciAdi = ViewBag.OgrenciAdi as string;
    var kalanBorc = ViewBag.KalanBorc as decimal? ?? 0;
    var toplamOdenen = ViewBag.ToplamOdenen as decimal? ?? 0;
  var odemePlani = ViewBag.OdemePlani as StudentApp.Models.OdemePlanlari;
    var taksitTutari = 0m;
    
    if (odemePlani != null && odemePlani.Taksit > 0)
    {
        taksitTutari = Math.Round(odemePlani.Tutar / odemePlani.Taksit, 2);
  }
}

<script>
    // Global fonksiyon - sayfa yüklenmeden önce tanýmlý olsun
    function doldurTaksit() {
      var taksitTutariValue = @(taksitTutari.ToString("F2", System.Globalization.CultureInfo.InvariantCulture));
        var kalanBorcValue = @(kalanBorc.ToString("F2", System.Globalization.CultureInfo.InvariantCulture));
        
      var input = document.getElementById('odenenTutarInput');
        var borcInput = document.getElementById('borcTutariInput');
    
        if (input) {
     input.value = taksitTutariValue;
            input.focus();
       
  // Görsel feedback
input.style.borderColor = '#198754';
    input.style.borderWidth = '3px';
    input.style.transition = 'all 0.3s ease';
            
       setTimeout(function() {
       input.style.borderColor = '';
             input.style.borderWidth = '';
            }, 1000);
            
            // Kalan borcu hesapla
            if (borcInput) {
                var yeniBorc = Math.max(0, kalanBorcValue - taksitTutariValue);
            borcInput.value = yeniBorc.toFixed(2);
            }
            
   alert('Taksit tutarý girildi: ' + taksitTutariValue + ' TL');
        } else {
            alert('Hata: Input alaný bulunamadý!');
        }
    }
</script>

<div class="row justify-content-center">
  <div class="col-md-10">
        <div class="card">
     <div class="card-header bg-success text-white">
       <h4><i class="fas fa-lira-sign me-2"></i>Ödeme Gir</h4>
       </div>
 <div class="card-body">
           @if (!string.IsNullOrEmpty(ogrenciAdi))
      {
    <div class="alert alert-info mb-4">
         <div class="row">
      <div class="col-md-4">
        <h5 class="mb-2">
            <i class="fas fa-user me-1"></i>@ogrenciAdi
                    </h5>
              </div>
        <div class="col-md-8">
           <div class="row">
         <div class="col-md-4">
              <div class="mb-1">
        <strong>Toplam Ödenen:</strong>
   <span class="text-success">@toplamOdenen.ToString("C2")</span>
  </div>
      </div>
     <div class="col-md-4">
         <div>
    <strong>Kalan Borç:</strong>
    <span class="text-danger">@kalanBorc.ToString("C2")</span>
        </div>
        </div>
        @if (taksitTutari > 0)
  {
               <div class="col-md-4">
    <div>
    <strong>Taksit Tutarý:</strong>
     <button type="button" class="btn btn-sm btn-outline-primary" onclick="doldurTaksit(); return false;">
             @taksitTutari.ToString("C2") <i class="fas fa-arrow-right ms-1"></i>
                </button>
       </div>
   </div>
           }
     </div>
          </div>
      </div>

            @if (odemePlani != null && taksitTutari > 0)
             {
            <div class="mt-2 pt-2 border-top">
            <small class="text-muted">
    <strong>Ödeme Planý:</strong> @odemePlani.KursProgrami -
      <strong>@odemePlani.Taksit taksit</strong> ×
     <button type="button" class="btn btn-sm btn-link p-0 text-primary" onclick="doldurTaksit(); return false;">
         <strong>@taksitTutari.ToString("C2")</strong>
   </button> =
   <strong>@odemePlani.Tutar.ToString("C2")</strong>
  @if (odemePlani.Vade.HasValue)
    {
              <span> (@odemePlani.Vade gün vade)</span>
          }
  </small>
    </div>
             }
      </div>
   }

                <form asp-action="Create" method="post">
          <input type="hidden" asp-for="OgrenciId" />
     <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                    <div class="mb-3">
         <label asp-for="OdemeTarihi" class="form-label"></label>
          <div class="input-group">
        <span class="input-group-text"><i class="fas fa-calendar"></i></span>
         <input asp-for="OdemeTarihi" type="date" class="form-control" />
            </div>
        <span asp-validation-for="OdemeTarihi" class="text-danger"></span>
          <small class="form-text text-muted">Boþ býrakýlýrsa bugünün tarihi kullanýlýr</small>
         </div>

    <div class="mb-3">
         <label asp-for="OdenenTutar" class="form-label">
  Ödenen Tutar
        @if (taksitTutari > 0)
     {
            <button type="button" class="btn btn-sm btn-primary ms-2" onclick="doldurTaksit(); return false;">
              <i class="fas fa-hand-pointer me-1"></i>Taksit Tutarý: @taksitTutari.ToString("C2")
          </button>
 }
      </label>
           <div class="input-group">
        <span class="input-group-text"><i class="fas fa-lira-sign"></i></span>
           <input asp-for="OdenenTutar" type="number" step="0.01" class="form-control"
           placeholder="0.00" min="0.01" id="odenenTutarInput" />
        </div>
<span asp-validation-for="OdenenTutar" class="text-danger"></span>
          @if (taksitTutari > 0)
   {
  <small class="form-text text-muted">
           <i class="fas fa-info-circle me-1"></i>
     <span class="text-primary">Yukarýdaki butona týklayarak taksit tutarýný otomatik girebilirsiniz</span>
     </small>
    }
          </div>

   <div class="mb-3">
     <label asp-for="BorcTutari" class="form-label"></label>
             <div class="input-group">
       <span class="input-group-text"><i class="fas fa-money-bill-wave"></i></span>
   <input asp-for="BorcTutari" type="number" step="0.01" class="form-control"
         placeholder="0.00" min="0" value="@(kalanBorc)" id="borcTutariInput" />
          </div>
              <span asp-validation-for="BorcTutari" class="text-danger"></span>
            <small class="form-text text-muted">Ödeme sonrasý kalan borç tutarý</small>
   </div>

    <div class="mb-3">
     <label asp-for="Aciklama" class="form-label"></label>
       <textarea asp-for="Aciklama" class="form-control" rows="3"
     placeholder="Ödeme ile ilgili not veya açýklama..."></textarea>
             <span asp-validation-for="Aciklama" class="text-danger"></span>
        </div>

<div class="d-flex justify-content-between">
 <a asp-controller="Ogrenciler" asp-action="Index" class="btn btn-secondary">
     <i class="fas fa-arrow-left me-1"></i>Ýptal
      </a>
       <button type="submit" class="btn btn-success">
                <i class="fas fa-save me-1"></i>Ödemeyi Kaydet
            </button>
 </div>
    </form>
          </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Sayfa yüklendikten sonra input change event'i
      document.addEventListener('DOMContentLoaded', function() {
  var odenenInput = document.getElementById('odenenTutarInput');
            var borcInput = document.getElementById('borcTutariInput');
  var kalanBorcBaslangic = @(kalanBorc.ToString("F2", System.Globalization.CultureInfo.InvariantCulture));

   if (odenenInput && borcInput) {
          odenenInput.addEventListener('input', function() {
  var odenenTutar = parseFloat(this.value) || 0;
      var yeniBorc = Math.max(0, kalanBorcBaslangic - odenenTutar);
        borcInput.value = yeniBorc.toFixed(2);
            });
            }
      });
    </script>
}
