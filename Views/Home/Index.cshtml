@{
    ViewData["Title"] = "Hızlı Menü";
}

<div class="dashboard-container">
    <!-- Öğrenci Arama Filtresi - Accordion -->
    <div class="accordion mb-4" id="ogrenciAramaAccordion">
        <div class="accordion-item shadow-sm border-0">
            <h2 class="accordion-header" id="ogrenciAramaHeader">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ogrenciAramaCollapse" aria-expanded="false" aria-controls="ogrenciAramaCollapse" style="background: linear-gradient(135deg, var(--primary-50) 0%, var(--primary-100) 100%); color: var(--primary-900); font-weight: 600; border-radius: var(--radius-lg);">
                    <i class="fas fa-search me-2"></i>
                    <span>Öğrenci Arama</span>
                    <span class="badge bg-primary ms-2" id="selectedOgrenciBadge" style="display: none;">
                        <i class="fas fa-user me-1"></i>Seçili
                    </span>
                </button>
            </h2>
            <div id="ogrenciAramaCollapse" class="accordion-collapse collapse" aria-labelledby="ogrenciAramaHeader" data-bs-parent="#ogrenciAramaAccordion" style="overflow: visible;">
                <div class="accordion-body" style="overflow: visible;">
                    <div class="row">
                        <div class="col-md-12">
                            <label class="form-label">
                                <i class="fas fa-user me-1"></i>Öğrenci Seçin
                            </label>
                            <div class="position-relative" id="ogrenciSearchWrapper" style="overflow: visible;">
                                <input type="text" 
                                       id="ogrenciSearch" 
                                       class="form-control" 
                                       placeholder="İsim veya email yazarak arama yapın..."
                                       autocomplete="off" />
                                <div id="ogrenciDropdown" class="dropdown-menu w-100" style="max-height: 300px; overflow-y: auto; display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1055;">
                                    <div id="ogrenciList" class="list-group list-group-flush">
                                        <!-- Öğrenci listesi buraya gelecek -->
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted">Öğrenci adı, soyadı, TC No veya email ile arama yapabilirsiniz.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="quick-menu-grid">
        <!-- Öğrenci Yönetimi Bölümü -->
        <div class="menu-section">
            <h3 class="section-title">
                <i class="fas fa-users me-2"></i>Öğrenci Yönetimi
            </h3>
            <div class="menu-cards">
                <a asp-controller="Ogrenciler" asp-action="Index" class="menu-card">
                    <div class="menu-card-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="menu-card-content">
                        <h4 class="menu-card-title">Öğrenciler</h4>
                        <p class="menu-card-description">Öğrenci listesini görüntüleyin ve yönetin</p>
                    </div>
                    <div class="menu-card-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </a>
                <a asp-controller="Ogrenciler" asp-action="Create" class="menu-card">
                    <div class="menu-card-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="menu-card-content">
                        <h4 class="menu-card-title">Yeni Öğrenci</h4>
                        <p class="menu-card-description">Yeni öğrenci kaydı oluşturun</p>
                    </div>
                    <div class="menu-card-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </a>
            </div>
        </div>

        <!-- Ödeme Yönetimi Bölümü -->
        <div class="menu-section">
            <h3 class="section-title">
                <i class="fas fa-calendar-alt me-2"></i>Ödeme Yönetimi
            </h3>
            <div class="menu-cards">
                <a asp-controller="OdemePlanlari" asp-action="Index" class="menu-card">
                    <div class="menu-card-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="menu-card-content">
                        <h4 class="menu-card-title">Ödeme Planları</h4>
                        <p class="menu-card-description">Ödeme planlarını görüntüleyin</p>
                    </div>
                    <div class="menu-card-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </a>
                <a asp-controller="OdemePlanlari" asp-action="Create" class="menu-card">
                    <div class="menu-card-icon">
                        <i class="fas fa-calendar-plus"></i>
                    </div>
                    <div class="menu-card-content">
                        <h4 class="menu-card-title">Yeni Ödeme Planı</h4>
                        <p class="menu-card-description">Yeni ödeme planı oluşturun</p>
                    </div>
                    <div class="menu-card-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </a>
                <a asp-controller="OgrenciOdemeTakvimi" asp-action="Index" class="menu-card">
                    <div class="menu-card-icon">
                        <i class="fas fa-money-check-alt"></i>
                    </div>
                    <div class="menu-card-content">
                        <h4 class="menu-card-title">Ödeme Takvimleri</h4>
                        <p class="menu-card-description">Öğrenci ödeme takvimlerini görüntüleyin</p>
                    </div>
                    <div class="menu-card-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </a>
            </div>
        </div>

        <!-- Envanter Bölümü -->
        <div class="menu-section">
            <h3 class="section-title">
                <i class="fas fa-boxes me-2"></i>Envanter
            </h3>
            <div class="menu-cards">
                <a asp-controller="Envanterler" asp-action="Index" class="menu-card">
                    <div class="menu-card-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="menu-card-content">
                        <h4 class="menu-card-title">Envanter</h4>
                        <p class="menu-card-description">Envanter listesini görüntüleyin</p>
                    </div>
                    <div class="menu-card-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </a>
                <a asp-controller="Envanterler" asp-action="Create" class="menu-card">
                    <div class="menu-card-icon">
                        <i class="fas fa-box-open"></i>
                    </div>
                    <div class="menu-card-content">
                        <h4 class="menu-card-title">Yeni Envanter</h4>
                        <p class="menu-card-description">Yeni envanter kaydı oluşturun</p>
                    </div>
                    <div class="menu-card-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </a>
            </div>
        </div>

        <!-- Araçlar Bölümü -->
        <div class="menu-section">
            <h3 class="section-title">
                <i class="fas fa-tools me-2"></i>Araçlar
            </h3>
            <div class="menu-cards">
                <a asp-controller="Zamanlayici" asp-action="Index" class="menu-card">
                    <div class="menu-card-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="menu-card-content">
                        <h4 class="menu-card-title">SMS Zamanlayıcı</h4>
                        <p class="menu-card-description">SMS gönderim zamanlayıcısını yönetin</p>
                    </div>
                    <div class="menu-card-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Öğrenci Detay Modal -->
<div class="modal fade" id="ogrenciDetayModal" tabindex="-1" aria-labelledby="ogrenciDetayModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%); color: white;">
                <h5 class="modal-title" id="ogrenciDetayModalLabel">
                    <i class="fas fa-user me-2"></i>Öğrenci Detayları
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="ogrenciDetayContent">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <p class="mt-3 text-muted">Yükleniyor...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let searchTimer;
        let selectedOgrenciId = null;

        // Öğrenci arama input
        const ogrenciSearch = document.getElementById('ogrenciSearch');
        const ogrenciDropdown = document.getElementById('ogrenciDropdown');
        const ogrenciList = document.getElementById('ogrenciList');

        if (ogrenciSearch && ogrenciDropdown && ogrenciList) {
            // Accordion kapandığında input'u temizle ve dropdown'ı kapat
            const collapseElement = document.getElementById('ogrenciAramaCollapse');
            const accordionBody = collapseElement ? collapseElement.querySelector('.accordion-body') : null;
            
            if (collapseElement) {
                // Accordion kapanmaya başladığında içeriği hemen gizle
                collapseElement.addEventListener('hide.bs.collapse', function () {
                    if (accordionBody) {
                        accordionBody.style.opacity = '0';
                        accordionBody.style.transition = 'opacity 0.1s ease';
                    }
                    // Dropdown'ı hemen kapat
                    ogrenciDropdown.style.display = 'none';
                });

                // Accordion tamamen kapandığında
                collapseElement.addEventListener('hidden.bs.collapse', function () {
                    // Input'u temizle (sadece seçili öğrenci yoksa)
                    if (!selectedOgrenciId) {
                        ogrenciSearch.value = '';
                    }
                    // Dropdown'ı kapat
                    ogrenciDropdown.style.display = 'none';
                    ogrenciList.innerHTML = '';
                    // Opacity'yi resetle (açıldığında görünsün)
                    if (accordionBody) {
                        accordionBody.style.opacity = '1';
                        accordionBody.style.transition = 'opacity 0.3s ease';
                    }
                });

                // Accordion açıldığında içeriği göster
                collapseElement.addEventListener('show.bs.collapse', function () {
                    if (accordionBody) {
                        accordionBody.style.opacity = '1';
                        accordionBody.style.transition = 'opacity 0.3s ease';
                    }
                });
            }

            // Input'a odaklanınca dropdown'ı göster
            ogrenciSearch.addEventListener('focus', async function() {
                const searchTerm = ogrenciSearch.value.trim();
                await searchOgrenci(searchTerm, true);
            });

            // Input'tan yazı yazınca arama yap - her karakterde
            ogrenciSearch.addEventListener('input', function(e) {
                clearTimeout(searchTimer);
                const searchTerm = e.target.value.trim();
                
                // Anında arama yap (debounce sadece 100ms)
                searchTimer = setTimeout(async () => {
                    await searchOgrenci(searchTerm, true);
                }, 100);
            });

            // Dışarı tıklanınca dropdown'ı kapat
            document.addEventListener('click', function(e) {
                if (!ogrenciSearch.contains(e.target) && !ogrenciDropdown.contains(e.target) && 
                    !e.target.closest('#ogrenciSearchWrapper')) {
                    ogrenciDropdown.style.display = 'none';
                }
            });

            // Öğrenci arama fonksiyonu
            async function searchOgrenci(searchTerm, showDropdown = false) {
                try {
                    // searchTerm boş olsa bile arama yap (tüm öğrencileri getir)
                    const response = await fetch(`@Url.Action("GetOgrenciList", "Home")?searchTerm=${encodeURIComponent(searchTerm || '')}`);
                    const ogrenciler = await response.json();

                    ogrenciList.innerHTML = '';

                    if (ogrenciler.length === 0) {
                        ogrenciList.innerHTML = '<div class="list-group-item text-muted text-center">Öğrenci bulunamadı</div>';
                        if (showDropdown) {
                            ogrenciDropdown.style.display = 'block';
                        }
                        return;
                    }

                    ogrenciler.forEach(ogrenci => {
                        const item = document.createElement('div');
                        item.className = 'list-group-item list-group-item-action';
                        item.style.cursor = 'pointer';
                        
                        // Eşleşen kısmı vurgula
                        let highlightedName = ogrenci.adSoyad;
                        if (searchTerm && searchTerm.trim().length > 0) {
                            const regex = new RegExp(`(${searchTerm.trim()})`, 'gi');
                            highlightedName = ogrenci.adSoyad.replace(regex, '<mark>$1</mark>');
                        }
                        
                        item.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${highlightedName}</strong>
                                    ${ogrenci.tcno ? `<br><small class="text-muted"><i class="fas fa-id-card me-1"></i>${ogrenci.tcno}</small>` : ''}
                                </div>
                                <i class="fas fa-chevron-right text-muted"></i>
                            </div>
                        `;
                        item.addEventListener('click', async () => {
                            selectedOgrenciId = ogrenci.id;
                            ogrenciSearch.value = ogrenci.adSoyad;
                            ogrenciDropdown.style.display = 'none';
                            
                            // Badge'i göster
                            const badge = document.getElementById('selectedOgrenciBadge');
                            if (badge) {
                                badge.style.display = 'inline-block';
                            }
                            
                            // Accordion'u kapat (smooth kapanış için biraz bekle)
                            setTimeout(() => {
                                const collapse = document.getElementById('ogrenciAramaCollapse');
                                if (collapse) {
                                    const bsCollapse = bootstrap.Collapse.getInstance(collapse);
                                    if (bsCollapse) {
                                        bsCollapse.hide();
                                    }
                                }
                            }, 100);
                            
                            await showOgrenciDetay(ogrenci.id);
                        });
                        ogrenciList.appendChild(item);
                    });

                    // Dropdown'ı göster
                    if (showDropdown && ogrenciler.length > 0) {
                        ogrenciDropdown.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Arama hatası:', error);
                    ogrenciList.innerHTML = '<div class="list-group-item text-danger text-center">Bir hata oluştu</div>';
                }
            }

            // Öğrenci detaylarını göster
            async function showOgrenciDetay(ogrenciId) {
                const modal = new bootstrap.Modal(document.getElementById('ogrenciDetayModal'));
                const content = document.getElementById('ogrenciDetayContent');

                // Modal içeriğini temizle ve loading göster
                content.innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Yükleniyor...</span>
                        </div>
                        <p class="mt-3 text-muted">Yükleniyor...</p>
                    </div>
                `;
                modal.show();

                try {
                    // Öğrenci detaylarını ve ödeme takvimlerini al
                    const [detayResponse, odemeResponse] = await Promise.all([
                        fetch(`@Url.Action("GetOgrenciDetay", "Home")?id=${ogrenciId}`),
                        fetch(`@Url.Action("GetOgrenciOdemeTakvimi", "Home")?id=${ogrenciId}`)
                    ]);

                    const ogrenci = await detayResponse.json();
                    const odemeler = await odemeResponse.json();

                    if (detayResponse.status === 404 || ogrenci.error) {
                        content.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>Öğrenci bulunamadı.
                            </div>
                        `;
                        return;
                    }

                    // Kişisel Bilgiler
                    let personalInfoHtml = `
                        <h5 class="mb-3"><i class="fas fa-user me-2 text-primary"></i>Kişisel Bilgiler</h5>
                        <dl class="row">
                            <dt class="col-sm-4">Ad</dt>
                            <dd class="col-sm-8"><i class="fas fa-user-circle me-1"></i>${ogrenci.ad}</dd>
                            
                            <dt class="col-sm-4">Soyad</dt>
                            <dd class="col-sm-8">${ogrenci.soyad}</dd>
                    `;

                    if (ogrenci.tcno) {
                        personalInfoHtml += `
                            <dt class="col-sm-4">TC No</dt>
                            <dd class="col-sm-8"><i class="fas fa-id-card me-1"></i>${ogrenci.tcno}</dd>
                        `;
                    }

                    personalInfoHtml += `
                            <dt class="col-sm-4">Doğum Tarihi</dt>
                            <dd class="col-sm-8">${ogrenci.dogumTarihi} <span class="badge bg-info">${ogrenci.yas} yaşında</span></dd>
                            
                            <dt class="col-sm-4">Cinsiyet</dt>
                            <dd class="col-sm-8">
                                <i class="fas ${ogrenci.cinsiyet === 'Erkek' ? 'fa-mars text-primary' : ogrenci.cinsiyet === 'Kadın' ? 'fa-venus text-danger' : 'fa-genderless text-secondary'} me-1"></i>
                                <strong>${ogrenci.cinsiyet || 'Belirtilmemiş'}</strong>
                            </dd>
                            
                            <dt class="col-sm-4">Kayıt Tarihi</dt>
                            <dd class="col-sm-8"><i class="fas fa-calendar me-1"></i>${ogrenci.kayitTarihi}</dd>
                            
                            <dt class="col-sm-4">Durum</dt>
                            <dd class="col-sm-8">
                                <span class="badge ${ogrenci.durum === 'Aktif' ? 'bg-success' : 'bg-secondary'}">
                                    <i class="fas fa-${ogrenci.durum === 'Aktif' ? 'check' : 'times'} me-1"></i>${ogrenci.durum}
                                </span>
                            </dd>
                        </dl>
                    `;

                    // İletişim Bilgileri
                    let contactInfoHtml = `
                        <hr class="my-4">
                        <h5 class="mb-3"><i class="fas fa-address-card me-2 text-primary"></i>İletişim Bilgileri</h5>
                        <dl class="row">
                            <dt class="col-sm-4">Email</dt>
                            <dd class="col-sm-8">
                                <a href="mailto:${ogrenci.email || ''}" class="text-decoration-none">
                                    <i class="fas fa-envelope me-1"></i>${ogrenci.email || '-'}
                                </a>
                            </dd>
                    `;

                    if (ogrenci.telefon) {
                        contactInfoHtml += `
                            <dt class="col-sm-4">Telefon</dt>
                            <dd class="col-sm-8">
                                <a href="tel:${ogrenci.telefon}" class="text-decoration-none">
                                    <i class="fas fa-phone me-1"></i>${ogrenci.telefon}
                                </a>
                            </dd>
                        `;
                    }

                    if (ogrenci.adres) {
                        contactInfoHtml += `
                            <dt class="col-sm-4">Adres</dt>
                            <dd class="col-sm-8">
                                <i class="fas fa-map-marker-alt me-1"></i>${ogrenci.adres}
                            </dd>
                        `;
                    }

                    if (ogrenci.veliAdSoyad || ogrenci.veliTelefon) {
                        contactInfoHtml += `
                            ${ogrenci.veliAdSoyad ? `
                            <dt class="col-sm-4">Veli Ad Soyad</dt>
                            <dd class="col-sm-8">
                                <i class="fas fa-user me-1"></i>${ogrenci.veliAdSoyad}
                            </dd>
                            ` : ''}
                            ${ogrenci.veliTelefon ? `
                            <dt class="col-sm-4">Veli Telefon</dt>
                            <dd class="col-sm-8">
                                <a href="tel:${ogrenci.veliTelefon}" class="text-decoration-none">
                                    <i class="fas fa-phone me-1"></i>${ogrenci.veliTelefon}
                                </a>
                            </dd>
                            ` : ''}
                        `;
                    }

                    contactInfoHtml += `</dl>`;

                    // Ödeme Bilgileri
                    let paymentInfoHtml = `
                        <hr class="my-4">
                        <h5 class="mb-3"><i class="fas fa-credit-card me-2 text-primary"></i>Ödeme Bilgileri</h5>
                        <dl class="row">
                    `;

                    if (ogrenci.odemePlani) {
                        paymentInfoHtml += `
                            <dt class="col-sm-4">Ödeme Planı</dt>
                            <dd class="col-sm-8">
                                <div class="card bg-light">
                                    <div class="card-body p-3">
                                        <h6 class="mb-2"><i class="fas fa-book me-1"></i>${ogrenci.odemePlani.kursProgrami}</h6>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <small class="text-muted d-block">Toplam Tutar</small>
                                                <strong class="text-success">₺ ${ogrenci.odemePlani.toplamTutar.toFixed(2)}</strong>
                                            </div>
                                            <div class="col-md-4">
                                                <small class="text-muted d-block">Taksit Sayısı</small>
                                                <span class="badge bg-primary">${ogrenci.odemePlani.taksitSayisi} Taksit</span>
                                            </div>
                                            <div class="col-md-4">
                                                <small class="text-muted d-block">Taksit Tutarı</small>
                                                <strong class="text-info">₺ ${ogrenci.odemePlani.taksitTutari.toFixed(2)}</strong>
                                            </div>
                                        </div>
                                        ${ogrenci.odemePlani.vade ? `
                                        <div class="mt-2">
                                            <small class="text-muted">Vade:</small>
                                            <span class="badge bg-warning text-dark ms-1">${ogrenci.odemePlani.vade} gün</span>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </dd>
                        `;
                    } else {
                        paymentInfoHtml += `
                            <dt class="col-sm-4">Ödeme Planı</dt>
                            <dd class="col-sm-8"><span class="text-muted">Belirtilmemiş</span></dd>
                        `;
                    }

                    if (ogrenci.ilkTaksitSonOdemeTarihi) {
                        paymentInfoHtml += `
                            <dt class="col-sm-4">İlk Taksit Son Ödeme Tarihi</dt>
                            <dd class="col-sm-8">
                                <i class="fas fa-calendar-check me-1"></i>${ogrenci.ilkTaksitSonOdemeTarihi}
                            </dd>
                        `;
                    }

                    paymentInfoHtml += `</dl>`;

                    // Ödeme Takvimi Accordion
                    let odemeTakvimiHtml = '';
                    if (odemeler && odemeler.length > 0) {
                        odemeTakvimiHtml = `
                            <hr class="my-4">
                            <div class="accordion" id="odemeTakvimiAccordion">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOdemeTakvimi" aria-expanded="false">
                                            <i class="fas fa-money-check-alt me-2"></i>Ödeme Takvimi
                                            <span class="badge bg-primary ms-2">${odemeler.length} Taksit</span>
                                        </button>
                                    </h2>
                                    <div id="collapseOdemeTakvimi" class="accordion-collapse collapse" data-bs-parent="#odemeTakvimiAccordion">
                                        <div class="accordion-body p-0">
                                            <div class="table-responsive">
                                                <table class="table table-sm table-hover mb-0">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Taksit No</th>
                                                            <th>Taksit Tutarı</th>
                                                            <th>Son Ödeme Tarihi</th>
                                                            <th>Ödeme Tarihi</th>
                                                            <th>Ödenen Tutar</th>
                                                            <th>Kalan Borç</th>
                                                            <th>Durum</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                        `;

                        odemeler.forEach(odeme => {
                            const isGecikmis = odeme.gecikmeGunu && odeme.gecikmeGunu > 0 && !odeme.odendi;
                            odemeTakvimiHtml += `
                                <tr class="${!odeme.odendi ? 'table-warning' : ''}">
                                    <td>
                                        ${odeme.taksitNo ? `<span class="badge bg-primary">Taksit ${odeme.taksitNo}</span>` : '<span class="text-muted">-</span>'}
                                    </td>
                                    <td>
                                        ${odeme.taksitTutari ? `<span class="badge bg-info">₺ ${odeme.taksitTutari.toFixed(2)}</span>` : '<span class="text-muted">-</span>'}
                                    </td>
                                    <td>
                                        ${odeme.sonOdemeTarihi ? `
                                            ${isGecikmis ? `
                                                <span class="text-danger">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>${odeme.sonOdemeTarihi}
                                                    <br><small>(${odeme.gecikmeGunu} gün gecikme)</small>
                                                </span>
                                            ` : `<i class="fas fa-calendar-check me-1"></i>${odeme.sonOdemeTarihi}`}
                                        ` : '<span class="text-muted">-</span>'}
                                    </td>
                                    <td>
                                        ${odeme.odemeTarihi ? `<i class="fas fa-calendar me-1"></i>${odeme.odemeTarihi}` : '<span class="text-muted">-</span>'}
                                    </td>
                                    <td>
                                        <span class="badge bg-success">₺ ${odeme.odenenTutar.toFixed(2)}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning text-dark">₺ ${odeme.borcTutari.toFixed(2)}</span>
                                    </td>
                                    <td>
                                        <span class="badge ${odeme.odendi ? 'bg-success' : 'bg-warning text-dark'}">
                                            <i class="fas fa-${odeme.odendi ? 'check-circle' : 'hourglass-half'} me-1"></i>
                                            ${odeme.odendi ? 'Ödendi' : 'Bekliyor'}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        });

                        odemeTakvimiHtml += `
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    // Envanter Satış Geçmişi
                    let envanterSatisHtml = '';
                    if (ogrenci.envanterSatislari && ogrenci.envanterSatislari.length > 0) {
                        envanterSatisHtml = `
                            <hr class="my-4">
                            <h5 class="mb-3">
                                <i class="fas fa-boxes me-2 text-primary"></i>Envanter Satış Geçmişi
                                <span class="badge bg-primary ms-2">${ogrenci.envanterSatislari.length}</span>
                            </h5>
                            
                            <div class="card bg-light mb-3">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-muted mb-1">Toplam Harcama</h6>
                                            <h4 class="mb-0">₺ ${ogrenci.toplamEnvanterHarcama.toFixed(2)}</h4>
                                        </div>
                                        <div class="col-md-6 text-end">
                                            <h6 class="text-muted mb-1">İşlem Sayısı</h6>
                                            <h4 class="mb-0">${ogrenci.envanterSatislari.length} Adet</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th><i class="fas fa-calendar me-1"></i>Satış Tarihi</th>
                                            <th><i class="fas fa-box me-1"></i>Envanter</th>
                                            <th class="text-center"><i class="fas fa-sort-numeric-up me-1"></i>Adet</th>
                                            <th class="text-end"><i class="fa-solid fa-turkish-lira-sign me-1"></i>Ödenen Tutar</th>
                                            <th><i class="fas fa-comment me-1"></i>Açıklama</th>
                                            <th class="text-center"><i class="fas fa-toggle-on me-1"></i>Durum</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        ogrenci.envanterSatislari.forEach(satis => {
                            envanterSatisHtml += `
                                <tr>
                                    <td>
                                        ${satis.satisTarihi ? `<i class="fas fa-calendar-alt me-1"></i>${satis.satisTarihi}` : '<span class="text-muted">-</span>'}
                                    </td>
                                    <td>
                                        <strong>${satis.envanterAdi}</strong>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info fs-6">${satis.satisAdet}</span>
                                    </td>
                                    <td class="text-end">
                                        <span class="badge bg-success fs-6">₺ ${satis.odenenTutar.toFixed(2)}</span>
                                    </td>
                                    <td>
                                        ${satis.aciklama ? `<small>${satis.aciklama}</small>` : '<span class="text-muted">-</span>'}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge ${satis.aktif ? 'bg-success' : 'bg-secondary'}">
                                            <i class="fas fa-${satis.aktif ? 'check-circle' : 'times-circle'} me-1"></i>
                                            ${satis.aktif ? 'Aktif' : 'İptal'}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        });

                        envanterSatisHtml += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        envanterSatisHtml = `
                            <hr class="my-4">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Henüz envanter satış geçmişi bulunmamaktadır.
                            </div>
                        `;
                    }

                    // Başarılar
                    let basarilarHtml = '';
                    if (ogrenci.basarilar && ogrenci.basarilar.length > 0) {
                        basarilarHtml = `
                            <hr class="my-4">
                            <h5 class="mb-3">
                                <i class="fas fa-trophy me-2 text-primary"></i>Başarılar
                                <span class="badge bg-primary ms-2">${ogrenci.basarilar.length}</span>
                            </h5>
                            <div class="row">
                        `;

                        ogrenci.basarilar.forEach(basari => {
                            basarilarHtml += `
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="card-title mb-0">
                                                    <i class="fas fa-trophy text-warning me-2"></i>${basari.baslik}
                                                </h6>
                                            </div>
                                            <div class="mb-2">
                                                <span class="badge bg-primary">${basari.turu}</span>
                                                ${basari.tarih ? `<span class="badge bg-info ms-1"><i class="fas fa-calendar me-1"></i>${basari.tarih}</span>` : ''}
                                            </div>
                                            ${basari.aciklama ? `<p class="card-text text-muted small mb-0">${basari.aciklama}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });

                        basarilarHtml += `
                            </div>
                        `;
                    } else {
                        basarilarHtml = `
                            <hr class="my-4">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Henüz başarı kaydı bulunmamaktadır.
                            </div>
                        `;
                    }

                    // Tüm içeriği birleştir
                    content.innerHTML = personalInfoHtml + contactInfoHtml + paymentInfoHtml + odemeTakvimiHtml + envanterSatisHtml + basarilarHtml;

                } catch (error) {
                    console.error('Detay yükleme hatası:', error);
                    content.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>Bilgiler yüklenirken bir hata oluştu.
                        </div>
                    `;
                }
            }
        }
    </script>
}

@section Styles {
    <style>
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem 1rem;
            min-height: calc(100vh - 200px);
            display: flex;
            flex-direction: column;
        }

        .page-header {
            margin-bottom: 1.5rem;
            text-align: center;
            flex-shrink: 0;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-subtitle {
            color: var(--gray-600);
            font-size: 0.95rem;
            margin: 0;
        }

        .quick-menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
            flex: 1;
            align-content: start;
            position: relative;
            z-index: 1;
        }

        .menu-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--primary-700);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-100);
            flex-shrink: 0;
        }

        .menu-cards {
            display: flex;
            flex-direction: column;
            gap: 0.875rem;
            flex: 1;
            min-height: 0;
        }

        .menu-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-primary);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            text-decoration: none;
            color: inherit;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .menu-card:hover::before {
            left: 100%;
        }

        .menu-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-400);
            background: white;
        }

        .menu-card-icon {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            border-radius: var(--radius-md);
            color: white;
            font-size: 1.25rem;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base);
        }

        .menu-card:hover .menu-card-icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: var(--shadow-lg);
        }

        .menu-card-content {
            flex: 1;
            min-width: 0;
        }

        .menu-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-800);
            margin: 0 0 0.25rem 0;
            transition: color var(--transition-base);
            line-height: 1.3;
        }

        .menu-card:hover .menu-card-title {
            color: var(--primary-700);
        }

        .menu-card-description {
            font-size: 0.8125rem;
            color: var(--gray-600);
            margin: 0;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .menu-card-arrow {
            flex-shrink: 0;
            color: var(--gray-400);
            font-size: 1rem;
            transition: all var(--transition-base);
        }

        .menu-card:hover .menu-card-arrow {
            color: var(--primary-600);
            transform: translateX(5px);
        }

        /* Büyük ekranlar için özel düzenleme - tek ekrana sığdır */
        @@media (min-width: 1200px) {
            .dashboard-container {
                padding: 1.5rem 1.5rem;
            }

            .page-header {
                margin-bottom: 1.25rem;
            }

            .page-title {
                font-size: 1.5rem;
            }

            .quick-menu-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .menu-section {
                padding: 1rem;
            }

            .section-title {
                font-size: 1rem;
                margin-bottom: 0.75rem;
                padding-bottom: 0.5rem;
            }

            .menu-cards {
                gap: 0.75rem;
            }

            .menu-card {
                padding: 0.875rem;
                gap: 0.875rem;
            }

            .menu-card-icon {
                width: 44px;
                height: 44px;
                font-size: 1.125rem;
            }

            .menu-card-title {
                font-size: 0.9375rem;
            }

            .menu-card-description {
                font-size: 0.75rem;
            }
        }

        /* Orta ekranlar (1024px - 1199px) */
        @@media (min-width: 1024px) and (max-width: 1199px) {
            .quick-menu-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1.125rem;
            }

            .menu-section {
                padding: 1.125rem;
            }
        }

        /* Tablet görünümü için */
        @@media (min-width: 769px) and (max-width: 1023px) {
            .quick-menu-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .menu-cards {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }

        /* Mobil Uyumluluk */
        @@media (max-width: 768px) {
            .dashboard-container {
                padding: 1rem 0.5rem;
                min-height: auto;
            }

            .page-header {
                margin-bottom: 1.5rem;
            }

            .page-title {
                font-size: 1.5rem;
                flex-direction: column;
            }

            .page-subtitle {
                font-size: 1rem;
            }

            .quick-menu-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .menu-section {
                padding: 1.5rem 1rem;
            }

            .section-title {
                font-size: 1.25rem;
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 1rem;
            }

            .menu-cards {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            .menu-card {
                padding: 1.25rem;
                gap: 1rem;
            }

            .menu-card-icon {
                width: 50px;
                height: 50px;
                font-size: 1.25rem;
            }

            .menu-card-title {
                font-size: 1rem;
            }

            .menu-card-description {
                font-size: 0.8125rem;
                -webkit-line-clamp: 3;
            }

            .menu-card-arrow {
                font-size: 1rem;
            }
        }

        @@media (max-width: 576px) {
            .dashboard-container {
                padding: 0.5rem;
            }

            .page-header {
                margin-bottom: 1.5rem;
            }

            .page-title {
                font-size: 1.25rem;
            }

            .page-subtitle {
                font-size: 0.9rem;
            }

            .quick-menu-grid {
                gap: 1.5rem;
            }

            .menu-section {
                padding: 1rem;
            }

            .section-title {
                font-size: 1.125rem;
                margin-bottom: 1rem;
            }

            .menu-card {
                padding: 1rem;
            }
        }

        /* Öğrenci Arama Accordion */
        #ogrenciAramaAccordion {
            position: relative;
            z-index: 10;
        }

        #ogrenciAramaAccordion .accordion-item {
            border: 2px solid var(--primary-200);
            border-radius: var(--radius-lg);
            overflow: visible;
            position: relative;
            z-index: 10;
            transition: all 0.35s ease;
        }

        /* Accordion collapsing sırasında z-index'i koru */
        #ogrenciAramaAccordion .accordion-collapse {
            position: relative;
            z-index: 10;
        }

        #ogrenciAramaAccordion .accordion-collapse.collapsing {
            z-index: 10;
        }

        #ogrenciAramaAccordion .accordion-collapse.show {
            z-index: 10;
        }

        #ogrenciAramaAccordion .accordion-button {
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
            position: relative;
            z-index: 11;
        }

        #ogrenciAramaAccordion .accordion-button:not(.collapsed) {
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            box-shadow: var(--shadow-md);
        }

        #ogrenciAramaAccordion .accordion-button.collapsed {
            background: linear-gradient(135deg, var(--primary-50) 0%, var(--primary-100) 100%);
            color: var(--primary-900);
            font-weight: 600;
            border: 2px solid var(--primary-200);
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.15);
        }

        #ogrenciAramaAccordion .accordion-button.collapsed:hover {
            background: linear-gradient(135deg, var(--primary-100) 0%, var(--primary-200) 100%);
            border-color: var(--primary-300);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
            transform: translateY(-1px);
        }

        #ogrenciAramaAccordion .accordion-button:focus {
            box-shadow: 0 0 0 0.25rem rgba(79, 70, 229, 0.25);
            border-color: var(--primary-400);
        }

        #ogrenciAramaAccordion .accordion-body {
            border-top: 2px solid var(--primary-200);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            background: white;
            position: relative;
            z-index: 10;
            transition: opacity 0.1s ease;
        }

        /* Accordion kapanırken içeriği hemen gizle */
        #ogrenciAramaAccordion .accordion-collapse.collapsing .accordion-body {
            opacity: 0;
            transition: opacity 0.1s ease;
        }

        /* Alttaki menü grid'inin z-index'ini düşür */
        .quick-menu-grid {
            position: relative;
            z-index: 1;
        }

        #selectedOgrenciBadge {
            animation: fadeIn 0.3s ease-in;
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Dropdown içindeki mark (highlight) stili */
        #ogrenciList mark {
            background-color: var(--warning-300);
            color: var(--gray-900);
            padding: 0.1rem 0.2rem;
            border-radius: 0.25rem;
            font-weight: 600;
        }

        /* Öğrenci Arama Dropdown */
        .position-relative {
            position: relative;
        }

        #ogrenciSearchWrapper {
            position: relative;
            z-index: 1;
        }

        #ogrenciDropdown {
            position: absolute !important;
            top: 100% !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 1055 !important;
            margin-top: 0.25rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            background: white;
        }

        #ogrenciList .list-group-item {
            border: none;
            border-bottom: 1px solid var(--gray-200);
            transition: background-color var(--transition-base);
        }

        #ogrenciList .list-group-item:last-child {
            border-bottom: none;
        }

        #ogrenciList .list-group-item:hover {
            background-color: var(--primary-50);
        }

        /* Modal İyileştirmeleri */
        #ogrenciDetayModal .modal-content {
            border: none;
            box-shadow: var(--shadow-xl);
        }

        #ogrenciDetayModal .modal-header {
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        #ogrenciDetayModal .accordion-button {
            font-weight: 600;
        }

        #ogrenciDetayModal .accordion-button:not(.collapsed) {
            background-color: var(--primary-50);
            color: var(--primary-700);
        }

        #ogrenciDetayModal .table-warning {
            background-color: #fff3cd !important;
        }
    </style>
}

