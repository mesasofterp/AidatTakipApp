@model StudentApp.Models.Ogrenciler
@using StudentApp.Models.ViewModels

@{
    ViewData["Title"] = "Öğrenci Düzenle";
}

<div class="row justify-content-center">
    <div class="col-md-11 col-lg-10">
        <div class="card shadow-lg border-0">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-user-edit me-2"></i>Öğrenci Düzenle</h4>
            </div>
            <div class="card-body">
                <form asp-action="Edit" method="post">
                    <input asp-for="Id" type="hidden" />
                    <input asp-for="Aktif" type="hidden" />
                    <input asp-for="IsDeleted" type="hidden" />
                    <input asp-for="Version" type="hidden" />
                    <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

                    <h5 class="mb-3"><i class="fas fa-user me-2"></i>Kişisel Bilgiler</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="OgrenciAdi" class="form-label"></label>
                            <input asp-for="OgrenciAdi" class="form-control" placeholder="Adınızı girin" />
                            <span asp-validation-for="OgrenciAdi" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="OgrenciSoyadi" class="form-label"></label>
                            <input asp-for="OgrenciSoyadi" class="form-control" placeholder="Soyadınızı girin" />
                            <span asp-validation-for="OgrenciSoyadi" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="TCNO" class="form-label"></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                <input asp-for="TCNO" type="text" class="form-control" placeholder="12345678901" maxlength="11" />
                            </div>
                            <span asp-validation-for="TCNO" class="text-danger"></span>
                            <small class="form-text text-muted">Opsiyonel - 11 haneli TC Kimlik No</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="DogumTarihi" class="form-label"></label>
                            <input asp-for="DogumTarihi" type="date" class="form-control" />
                            <span asp-validation-for="DogumTarihi" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="CinsiyetId" class="form-label"></label>
                            <select asp-for="CinsiyetId" class="form-select" asp-items="ViewBag.Cinsiyetler">
                                <option value="">-- Cinsiyet Seçiniz --</option>
                            </select>
                            <span asp-validation-for="CinsiyetId" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="KayitTarihi" class="form-label"></label>
                            <input asp-for="KayitTarihi" type="date" class="form-control" />
                            <span asp-validation-for="KayitTarihi" class="text-danger"></span>
                        </div>
                    </div>

                    <hr class="my-4" />
                    <h5 class="mb-3"><i class="fas fa-address-card me-2"></i>İletişim Bilgileri</h5>

                    <div class="mb-3">
                        <label asp-for="Email" class="form-label"></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                            <input asp-for="Email" type="email" class="form-control" placeholder="ornek@email.com" />
                        </div>
                        <span asp-validation-for="Email" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Telefon" class="form-label"></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-phone"></i></span>
                            <input asp-for="Telefon" id="telefonInput" type="text" class="form-control" placeholder="05301234567" maxlength="11" />
                        </div>
                        <span asp-validation-for="Telefon" class="text-danger"></span>
                        <small class="form-text text-muted">Format: 05301234567 (11 haneli, 0 ile başlamalı)</small>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Adres" class="form-label"></label>
                        <textarea asp-for="Adres" class="form-control" rows="3" placeholder="Tam adres bilgisi..."></textarea>
                        <span asp-validation-for="Adres" class="text-danger"></span>
                        <small class="form-text text-muted">Opsiyonel - Ev veya iş adresi</small>
                    </div>

                    <hr class="my-4" />
                    <h5 class="mb-3"><i class="fas fa-heartbeat me-2"></i>Fiziksel Bilgiler</h5>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="Boy" class="form-label"></label>
                            <div class="input-group">
                                <input asp-for="Boy" type="number" class="form-control" placeholder="175" min="0" max="300" />
                                <span class="input-group-text">cm</span>
                            </div>
                            <span asp-validation-for="Boy" class="text-danger"></span>
                            <small class="form-text text-muted">Opsiyonel - Boy bilgisi (cm)</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="Kilo" class="form-label"></label>
                            <div class="input-group">
                                <input asp-for="Kilo" type="number" step="0.1" value="@(Model.Kilo.HasValue? Model.Kilo.Value.ToString("F1", System.Globalization.CultureInfo.InvariantCulture) : "")" class="form-control" placeholder="70.5" min="0" max="500" />
                                <span class="input-group-text">kg</span>
                            </div>
                            <span asp-validation-for="Kilo" class="text-danger"></span>
                            <small class="form-text text-muted">Opsiyonel - Kilo bilgisi (kg)</small>
                        </div>
                    </div>

                    <hr class="my-4" />
                    <h5 class="mb-3"><i class="fas fa-users me-2"></i>Veli Bilgileri</h5>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="VeliAdSoyad" class="form-label">Veli Ad Soyad</label>
                            <input type="text" id="VeliAdSoyad" name="OgrenciDetay.VeliAdSoyad" value="@(Model.OgrenciDetay?.VeliAdSoyad ?? "")" class="form-control" placeholder="Veli adı ve soyadı" />
                            <small class="form-text text-muted">Opsiyonel</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="VeliTelefonNumarasi" class="form-label">Veli Telefon Numarası</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                <input type="text" id="VeliTelefonNumarasi" name="OgrenciDetay.VeliTelefonNumarasi" value="@(Model.OgrenciDetay?.VeliTelefonNumarasi ?? "")" class="form-control" placeholder="05301234567" maxlength="11" />
                            </div>
                            <small class="form-text text-muted">Opsiyonel - Format: 05301234567</small>
                        </div>
                    </div>
                    @if (Model.OgrenciDetay != null)
                    {
                        <input type="hidden" name="OgrenciDetay.Id" value="@Model.OgrenciDetay.Id" />
                    }
                    <input type="hidden" name="OgrenciDetay.OgrenciId" value="@Model.Id" />

                    <hr class="my-4" />
                    <h5 class="mb-3"><i class="fas fa-school me-2"></i>Okul Bilgileri</h5>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="OkulAdi" class="form-label">Okul Adı</label>
                            <input type="text" id="OkulAdi" name="OgrenciDetay.OkulAdi" value="@(Model.OgrenciDetay?.OkulAdi ?? "")" class="form-control" placeholder="Okul adı" />
                            <small class="form-text text-muted">Opsiyonel</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="Sinif" class="form-label">Sınıf</label>
                            <input type="text" id="Sinif" name="OgrenciDetay.Sinif" value="@(Model.OgrenciDetay?.Sinif ?? "")" class="form-control" placeholder="Örn: 5-A, 10/B" />
                            <small class="form-text text-muted">Opsiyonel</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="OkulAdresi" class="form-label">Okul Adresi</label>
                        <textarea id="OkulAdresi" name="OgrenciDetay.OkulAdresi" class="form-control" rows="2" placeholder="Okul adresi...">@(Model.OgrenciDetay?.OkulAdresi ?? "")</textarea>
                        <small class="form-text text-muted">Opsiyonel</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="OkulHocasiAdSoyad" class="form-label">Okul Hocası Ad Soyad</label>
                            <input type="text" id="OkulHocasiAdSoyad" name="OgrenciDetay.OkulHocasiAdSoyad" value="@(Model.OgrenciDetay?.OkulHocasiAdSoyad ?? "")" class="form-control" placeholder="Okul hocası adı ve soyadı" />
                            <small class="form-text text-muted">Opsiyonel</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="OkulHocasiTelefon" class="form-label">Okul Hocası Telefon</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                <input type="text" id="OkulHocasiTelefon" name="OgrenciDetay.OkulHocasiTelefon" value="@(Model.OgrenciDetay?.OkulHocasiTelefon ?? "")" class="form-control" placeholder="05301234567" maxlength="11" />
                            </div>
                            <small class="form-text text-muted">Opsiyonel - Format: 05301234567</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="OkulGirisSaati" class="form-label"><i class="fas fa-clock me-1"></i>Okul Giriş Saati</label>
                            <input type="time" id="OkulGirisSaati" name="OgrenciDetay.OkulGirisSaati"
                                   value="@(Model.OgrenciDetay?.OkulGirisSaati?.ToString(@"hh\:mm") ?? "")"
                                   class="form-control" />
                            <small class="form-text text-muted">Opsiyonel - Öğrencinin okula giriş saati</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="OkulCikisSaati" class="form-label"><i class="fas fa-clock me-1"></i>Okul Çıkış Saati</label>
                            <input type="time" id="OkulCikisSaati" name="OgrenciDetay.OkulCikisSaati"
                                   value="@(Model.OgrenciDetay?.OkulCikisSaati?.ToString(@"hh\:mm") ?? "")"
                                   class="form-control" />
                            <small class="form-text text-muted">Opsiyonel - Öğrencinin okuldan çıkış saati</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="SeansId" class="form-label"><i class="fas fa-clock me-2"></i>Seans</label>
                        <select asp-for="SeansId" class="form-select" asp-items="ViewBag.Seanslar">
                            <option value="">-- Seans Seçiniz --</option>
                        </select>
                        <span asp-validation-for="SeansId" class="text-danger"></span>
                        <small class="form-text text-muted">Opsiyonel - Öğrencinin katılacağı seans</small>
                    </div>

                    <hr class="my-4" />
                    <h5 class="mb-3"><i class="fas fa-trophy me-2"></i>Başarılar</h5>
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        Öğrencinin başarılarını görüntüleyebilir, yeni başarı ekleyebilir veya mevcut başarıları düzenleyebilirsiniz.
                        <a asp-controller="OgrenciBasarilari" asp-action="Index" asp-route-ogrenciId="@Model.Id" class="btn btn-sm btn-outline-primary ms-2">
                            <i class="fas fa-trophy me-1"></i>Başarıları Yönet
                        </a>
                    </div>

                    <hr class="my-4" />
                    <h5 class="mb-3"><i class="fas fa-boxes me-2"></i>Envanter Satışları</h5>
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        Öğrencinin envanter satışlarını görüntüleyebilir, yeni satış ekleyebilir veya mevcut satışları silebilirsiniz.
                    </div>

                    <div id="envanterSatisAlani" class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm" id="envanterTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="min-width: 180px;">
                                                <i class="fas fa-box me-1"></i>Envanter
                                            </th>
                                            <th style="min-width: 80px;" class="text-center">
                                                <i class="fas fa-sort-numeric-up me-1"></i>Adet
                                            </th>
                                            <th style="min-width: 150px;">
                                                <i class="fas fa-calendar me-1"></i>Satış Tarihi
                                            </th>
                                            <th style="min-width: 120px;">
                                                <i class="fa-solid fa-turkish-lira-sign me-1"></i>Ödenen Tutar
                                            </th>
                                            <th style="min-width: 120px;">
                                                <i class="fa-solid fa-turkish-lira-sign me-1"></i>Kalan Tutar
                                            </th>
                                            <th style="min-width: 150px;">
                                                <i class="fas fa-calendar-check me-1"></i>Kalan Tutar Tahsil Tarihi
                                            </th>
                                            <th style="min-width: 150px;">
                                                <i class="fas fa-comment me-1"></i>Not
                                            </th>
                                            <th style="min-width: 80px;" class="text-center">
                                                <i class="fas fa-trash me-1"></i>İşlem
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="envanterTbody">
                                        @if (ViewBag.MevcutEnvanterSatislari != null)
                                        {
                                            var mevcutSatislar = (List<EnvanterSatisViewModel>)ViewBag.MevcutEnvanterSatislari;
                                            for (int i = 0; i < mevcutSatislar.Count; i++)
                                            {
                                                var satis = mevcutSatislar[i];
                                                <tr class="envanter-satir" data-index="@i">
                                                    <td>
                                                        <input type="hidden" name="EnvanterSatislari[@i].Id" value="@satis.Id" />
                                                        <input type="hidden" name="EnvanterSatislari[@i].EnvanterId" value="@satis.EnvanterId" />
                                                        <input type="hidden" name="EnvanterSatislari[@i].SilinecekMi" value="false" class="silinecek-input" />
                                                        <strong>@satis.EnvanterAdi</strong>
                                                        <input type="hidden" class="envanter-adi-hidden" value="@satis.EnvanterAdi" />
                                                        <input type="hidden" class="envanter-satis-fiyat" value="@(ViewBag.EnvanterFiyatlari != null && ViewBag.EnvanterFiyatlari.ContainsKey(satis.EnvanterId) ? ViewBag.EnvanterFiyatlari[satis.EnvanterId].ToString("F2", System.Globalization.CultureInfo.InvariantCulture) : "0")" />
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="number" name="EnvanterSatislari[@i].SatisAdet" value="@satis.SatisAdet"
                                                               class="form-control form-control-sm text-center" min="1" required style="min-width: 60px;" />
                                                    </td>
                                                    <td>
                                                        <input type="date" name="EnvanterSatislari[@i].SatisTarihi"
                                                               value="@(satis.SatisTarihi?.ToString("yyyy-MM-dd") ?? DateTime.Now.ToString("yyyy-MM-dd"))"
                                                               class="form-control form-control-sm" style="min-width: 130px;" />
                                                    </td>
                                                    <td>
                                                        <input type="number" name="EnvanterSatislari[@i].OdenenTutar" value="@satis.OdenenTutar.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)"
                                                               class="form-control form-control-sm odenen-tutar-input" step="0.01" min="0" required style="min-width: 80px;" data-index="@i" />
                                                    </td>
                                                    <td>
                                                        <input type="number" name="EnvanterSatislari[@i].KalanTutar" value="@satis.KalanTutar.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)"
                                                               class="form-control form-control-sm kalan-tutar-input" step="0.01" min="0" readonly style="min-width: 80px; background-color: #e9ecef;" />
                                                    </td>
                                                    <td>
                                                        <input type="date" name="EnvanterSatislari[@i].KalanTutarTahsilTarihi"
                                                               value="@(satis.KalanTutarTahsilTarihi?.ToString("yyyy-MM-dd") ?? "")"
                                                               class="form-control form-control-sm kalan-tutar-tarih-input" style="min-width: 130px;" @(satis.KalanTutar <= 0 ? "disabled" : "") />
                                                    </td>
                                                    <td>
                                                        <input type="text" name="EnvanterSatislari[@i].Aciklama" value="@satis.Aciklama"
                                                               class="form-control form-control-sm" placeholder="Not..." style="min-width: 100px;" />
                                                    </td>
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-sm btn-danger sil-btn" title="Sil">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <button type="button" id="yeniSatirEkleBtn" class="btn btn-success btn-sm mt-2">
                                <i class="fas fa-plus me-1"></i>Yeni Envanter Satışı Ekle
                            </button>
                        </div>
                    </div>

                    <!-- Yeni Satır Template -->
                    <template id="yeniSatirTemplate">
                        <tr class="envanter-satir yeni-satir">
                            <td>
                                <input type="hidden" name="EnvanterSatislari[{INDEX}].Id" value="0" />
                                <input type="hidden" name="EnvanterSatislari[{INDEX}].SilinecekMi" value="false" class="silinecek-input" />
                                <select name="EnvanterSatislari[{INDEX}].EnvanterId" class="form-select form-select-sm envanter-select" required style="min-width: 150px;" data-index="{INDEX}">
                                    <option value="">-- Envanter Seçiniz --</option>
                                    @if (ViewBag.Envanterler != null)
                                    {
                                        foreach (var item in (IEnumerable<SelectListItem>)ViewBag.Envanterler)
                                        {
                                            <option value="@item.Value" data-satis-fiyat="@(ViewBag.EnvanterFiyatlari != null && ViewBag.EnvanterFiyatlari.ContainsKey(long.Parse(item.Value)) ? ViewBag.EnvanterFiyatlari[long.Parse(item.Value)].ToString("F2", System.Globalization.CultureInfo.InvariantCulture) : "0")">@item.Text</option>
                                        }
                                    }
                                </select>
                            </td>
                            <td class="text-center">
                                <input type="number" name="EnvanterSatislari[{INDEX}].SatisAdet" value="1"
                                       class="form-control form-control-sm text-center" min="1" required style="min-width: 60px;" />
                            </td>
                            <td>
                                <input type="date" name="EnvanterSatislari[{INDEX}].SatisTarihi"
                                       value="@DateTime.Now.ToString("yyyy-MM-dd")"
                                       class="form-control form-control-sm" style="min-width: 130px;" />
                            </td>
                            <td>
                                <input type="number" name="EnvanterSatislari[{INDEX}].OdenenTutar" value="0"
                                       class="form-control form-control-sm odenen-tutar-input" step="0.01" min="0" required style="min-width: 80px;" data-index="{INDEX}" />
                            </td>
                            <td>
                                <input type="number" name="EnvanterSatislari[{INDEX}].KalanTutar" value="0"
                                       class="form-control form-control-sm kalan-tutar-input" step="0.01" min="0" readonly style="min-width: 80px; background-color: #e9ecef;" />
                            </td>
                            <td>
                                <input type="date" name="EnvanterSatislari[{INDEX}].KalanTutarTahsilTarihi"
                                       class="form-control form-control-sm kalan-tutar-tarih-input" style="min-width: 130px;" />
                            </td>
                            <td>
                                <input type="text" name="EnvanterSatislari[{INDEX}].Aciklama"
                                       class="form-control form-control-sm" placeholder="Not..." style="min-width: 100px;" />
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-danger yeni-sil-btn" title="Satırı Kaldır">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                    </template>

                    <hr class="my-4" />
                    <h5 class="mb-3"><i class="fas fa-credit-card me-2"></i>Ödeme Bilgileri</h5>

                    <div class="mb-3">
                        <label asp-for="OdemePlanlariId" class="form-label"></label>
                        <select asp-for="OdemePlanlariId" class="form-select" asp-items="ViewBag.OdemePlanlari">
                            <option value="">-- Ödeme Planı Seçiniz --</option>
                        </select>
                        <span asp-validation-for="OdemePlanlariId" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="IlkTaksitSonOdemeTarihi" class="form-label"></label>
                        <input asp-for="IlkTaksitSonOdemeTarihi" type="date" class="form-control" disabled />
                        <input asp-for="IlkTaksitSonOdemeTarihi" type="hidden" />
                        <small class="form-text text-muted">
                            <i class="fas fa-lock me-1 text-warning"></i>
                            Bu alan sadece öğrenci kaydı sırasında belirlenir ve sonradan değiştirilemez.
                            @if (Model.IlkTaksitSonOdemeTarihi.HasValue)
                            {
                                <span class="text-info">Mevcut değer: @Model.IlkTaksitSonOdemeTarihi.Value.ToString("dd.MM.yyyy")</span>
                            }
                            else
                            {
                                <span class="text-muted">(Kayıt tarihi kullanılmış)</span>
                            }
                        </small>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Biyografi" class="form-label"></label>
                        <textarea asp-for="Biyografi" class="form-control" rows="5" placeholder="Öğrencinin biyografisi..."></textarea>
                        <span asp-validation-for="Biyografi" class="text-danger"></span>
                        <small class="form-text text-muted">Opsiyonel - Öğrencinin biyografisi</small>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Aciklama" class="form-label">Notlar / Açıklama</label>
                        <textarea asp-for="Aciklama" class="form-control" rows="3" placeholder="Öğrenci hakkında notlar veya açıklama..."></textarea>
                        <span asp-validation-for="Aciklama" class="text-danger"></span>
                        <small class="form-text text-muted">Opsiyonel - Öğrenci hakkında özel notlar</small>
                    </div>

                    <div class="d-flex flex-column flex-md-row justify-content-between gap-2 mt-4">
                        <a asp-action="Index" class="btn btn-secondary order-2 order-md-1">
                            <i class="fas fa-arrow-left me-1"></i><span class="d-none d-sm-inline">Listeye Dön</span><span class="d-sm-none">Geri</span>
                        </a>
                        <button type="submit" class="btn btn-primary order-1 order-md-2">
                            <i class="fas fa-save me-1"></i><span class="d-none d-sm-inline">Öğrenciyi Güncelle</span><span class="d-sm-none">Kaydet</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
                   // Telefon numarası input mask
                document.addEventListener('DOMContentLoaded', function() {
                   const telefonInput = document.getElementById('telefonInput');
                   const veliTelefonInput = document.getElementById('VeliTelefonNumarasi');
                   const okulHocasiTelefonInput = document.getElementById('OkulHocasiTelefon');

                  function applyPhoneMask(input) {
                      if (!input) return;
                      input.addEventListener('input', function(e) {
                          let value = e.target.value.replace(/\D/g, '');
                     if (value.length > 11) {
                        value = value.substring(0, 11);
                      }
                          if (value.length > 0 && value.charAt(0) !== '0') {
                       value = '0' + value.substring(0, 10);
                    }
                          e.target.value = value;
                      });
                      input.addEventListener('paste', function(e) {
                      setTimeout(function() {
                    let value = input.value.replace(/\D/g, '');
                 if (value.length > 11) {
                        value = value.substring(0, 11);
                  }
                        if (value.length > 0 && value.charAt(0) !== '0') {
                      value = '0' + value.substring(0, 10);
                    }
                              input.value = value;
                          }, 0);
                 });
                  }

                  applyPhoneMask(telefonInput);
                  applyPhoneMask(veliTelefonInput);
                  applyPhoneMask(okulHocasiTelefonInput);

              // Envanter Tablosu İşlemleri
              const tbody = document.getElementById('envanterTbody');
                 const yeniSatirEkleBtn = document.getElementById('yeniSatirEkleBtn');
                   const yeniSatirTemplate = document.getElementById('yeniSatirTemplate');
                   let yeniSatirIndex = @(ViewBag.MevcutEnvanterSatislari != null ? ((List<EnvanterSatisViewModel>)ViewBag.MevcutEnvanterSatislari).Count : 0);

                  console.log('Edit Envanter Script Yüklendi', {
         tbody: tbody ? 'OK' : 'NULL',
                yeniSatirEkleBtn: yeniSatirEkleBtn ? 'OK' : 'NULL',
                     yeniSatirTemplate: yeniSatirTemplate ? 'OK' : 'NULL',
        yeniSatirIndex: yeniSatirIndex
               });

         // Mevcut satırlar için event listener'ları ekle
          document.querySelectorAll('.envanter-satir').forEach(row => {
          setupMevcutSatirListeners(row);
                });

               // Yeni satır ekle
                   if (yeniSatirEkleBtn && yeniSatirTemplate && tbody) {
                yeniSatirEkleBtn.addEventListener('click', function() {
                 console.log('Yeni satır ekleme butonuna tıklandı, Index:', yeniSatirIndex);
            try {
              const templateContent = yeniSatirTemplate.content.cloneNode(true);
                    const templateHTML = templateContent.querySelector('tr').outerHTML;
                 const yeniSatir = templateHTML.replace(/{INDEX}/g, yeniSatirIndex);

                   tbody.insertAdjacentHTML('beforeend', yeniSatir);
             console.log('Satır eklendi, Yeni Index:', yeniSatirIndex + 1);

             // Yeni eklenen satıra event listener'ları ekle
               const yeniRow = tbody.lastElementChild;
                     setupEnvanterListeners(yeniRow, yeniSatirIndex);

             yeniSatirIndex++;

                // Yeni eklenen satırın sil butonunu dinle
                 guncelSilButonlari();
            } catch (error) {
             console.error('Satır eklenirken hata:', error);
              alert('Satır eklenirken bir hata oluştu: ' + error.message);
              }
          });
                } else {
                     console.error('Envanter bileşenleri bulunamadı!', {
                tbody: !!tbody,
                    yeniSatirEkleBtn: !!yeniSatirEkleBtn,
                    yeniSatirTemplate: !!yeniSatirTemplate
        });
                   }

                // Mevcut satırlar için listener'lar
                function setupMevcutSatirListeners(row) {
              const odenenTutarInput = row.querySelector('.odenen-tutar-input');
                const satisFiyatHidden = row.querySelector('.envanter-satis-fiyat');

               if (odenenTutarInput && satisFiyatHidden) {
                        odenenTutarInput.addEventListener('input', function() {
               hesaplaMevcutKalanTutar(row, satisFiyatHidden.value);
             });
                    }
                }

                // Mevcut satırlar için kalan tutar hesaplama
                function hesaplaMevcutKalanTutar(row, satisFiyat) {
                    const odenenTutarInput = row.querySelector('.odenen-tutar-input');
             const kalanTutarInput = row.querySelector('.kalan-tutar-input');
               const kalanTutarTarihInput = row.querySelector('.kalan-tutar-tarih-input');

             if (!odenenTutarInput || !kalanTutarInput) return;

               const satisFiyatValue = parseFloat(satisFiyat) || 0;
                    const odenenTutar = parseFloat(odenenTutarInput.value) || 0;

                    const kalanTutar = Math.max(0, satisFiyatValue - odenenTutar);
                    kalanTutarInput.value = kalanTutar.toFixed(2);

        // Kalan tutar varsa tarihi aktif et, yoksa temizle
                    if (kalanTutarTarihInput) {
               if (kalanTutar > 0) {
              kalanTutarTarihInput.removeAttribute('disabled');
                kalanTutarTarihInput.style.backgroundColor = '';
              } else {
                  kalanTutarTarihInput.value = '';
                kalanTutarTarihInput.setAttribute('disabled', 'disabled');
                kalanTutarTarihInput.style.backgroundColor = '#e9ecef';
                        }
              }
                }

                // Yeni satırlar için listener'lar
                function setupEnvanterListeners(row, index) {
                    const envanterSelect = row.querySelector('.envanter-select');
                    const odenenTutarInput = row.querySelector('.odenen-tutar-input');
              const kalanTutarInput = row.querySelector('.kalan-tutar-input');
             const kalanTutarTarihInput = row.querySelector('.kalan-tutar-tarih-input');

            if (envanterSelect) {
                      envanterSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
             const satisFiyat = parseFloat(selectedOption.getAttribute('data-satis-fiyat')) || 0;

            // Otomatik olarak satış fiyatını ödenen tutar alanına yerleştir
            if (odenenTutarInput) {
               odenenTutarInput.value = satisFiyat.toFixed(2);
             hesaplaKalanTutar(row);
                          }
                 });
           }

                    if (odenenTutarInput) {
         odenenTutarInput.addEventListener('input', function() {
                 hesaplaKalanTutar(row);
               });
           }
                }

            // Yeni satırlar için kalan tutar hesaplama
                function hesaplaKalanTutar(row) {
                    const envanterSelect = row.querySelector('.envanter-select');
          const odenenTutarInput = row.querySelector('.odenen-tutar-input');
           const kalanTutarInput = row.querySelector('.kalan-tutar-input');
                    const kalanTutarTarihInput = row.querySelector('.kalan-tutar-tarih-input');

           if (!envanterSelect || !odenenTutarInput || !kalanTutarInput) return;

                    const selectedOption = envanterSelect.options[envanterSelect.selectedIndex];
                    const satisFiyat = parseFloat(selectedOption.getAttribute('data-satis-fiyat')) || 0;
           const odenenTutar = parseFloat(odenenTutarInput.value) || 0;

                    const kalanTutar = Math.max(0, satisFiyat - odenenTutar);
                  kalanTutarInput.value = kalanTutar.toFixed(2);

          // Kalan tutar varsa tarihi aktif et, yoksa temizle
              if (kalanTutarTarihInput) {
               if (kalanTutar > 0) {
                      kalanTutarTarihInput.removeAttribute('disabled');
             kalanTutarTarihInput.style.backgroundColor = '';
                } else {
              kalanTutarTarihInput.value = '';
         kalanTutarTarihInput.setAttribute('disabled', 'disabled');
            kalanTutarTarihInput.style.backgroundColor = '#e9ecef';
                }
           }
                }

            // Mevcut kayıtların sil butonları (soft delete)
         document.querySelectorAll('.sil-btn').forEach(btn => {
                     btn.addEventListener('click', function() {
         if (confirm('Bu envanter satışını silmek istediğinizden emin misiniz? Stok geri eklenecektir.')) {
              const row = this.closest('tr');
                 const silinecekInput = row.querySelector('.silinecek-input');
            if (silinecekInput) {
                       silinecekInput.value = 'true';
         }

               // Satırı görsel olarak gizle ve işaretle
                    row.style.opacity = '0.5';
                   row.style.textDecoration = 'line-through';
           this.disabled = true;
             this.innerHTML = '<i class="fas fa-check"></i> Silinecek';
              this.classList.remove('btn-danger');
                 this.classList.add('btn-secondary');
            }
                  });
                });

         // Sil butonlarını güncelle
          function guncelSilButonlari() {
                       document.querySelectorAll('.yeni-sil-btn').forEach(btn => {
                      btn.removeEventListener('click', yeniSilHandler);
                btn.addEventListener('click', yeniSilHandler);
                   });
                   }

              function yeniSilHandler(e) {
                  const row = e.target.closest('tr');
            if (row && confirm('Bu satırı kaldırmak istediğinizden emin misiniz?')) {
           row.remove();
             // Index'leri yeniden düzenle
                         yenidenIndexle();
                      }
          }

                   // Satır index'lerini yeniden düzenle
        function yenidenIndexle() {
                const rows = tbody.querySelectorAll('tr');
                       rows.forEach((row, index) => {
           row.querySelectorAll('[name]').forEach(input => {
                     const name = input.getAttribute('name');
             if (name) {
          const newName = name.replace(/\[\d+\]/, `[${index}]`);
               input.setAttribute('name', newName);
                }
                 });
                 // data-index özelliğini güncelle
              row.querySelectorAll('[data-index]').forEach(element => {
                element.setAttribute('data-index', index);
            });
             });
           yeniSatirIndex = rows.length;
            }
                });
    </script>
}
