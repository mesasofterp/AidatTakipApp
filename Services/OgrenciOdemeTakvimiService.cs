using Microsoft.EntityFrameworkCore;
using StudentApp.Data;
using StudentApp.Models;

namespace StudentApp.Services
{
    public class OgrenciOdemeTakvimiService : IOgrenciOdemeTakvimiService
    {
        private readonly AppDbContext _context;

        public OgrenciOdemeTakvimiService(AppDbContext context)
    {
   _context = context;
        }

        public async Task<IEnumerable<OgrenciOdemeTakvimi>> GetAllOdemelerAsync()
        {
            return await _context.OgrenciOdemeTakvimi
   .Include(o => o.Ogrenci)
  .Where(o => !o.IsDeleted)
 .OrderByDescending(o => o.OdemeTarihi)
  .ToListAsync();
}

        public async Task<IEnumerable<OgrenciOdemeTakvimi>> GetOdemelerByOgrenciIdAsync(long ogrenciId)
        {
            return await _context.OgrenciOdemeTakvimi
                .Include(o => o.Ogrenci)
             .Where(o => o.OgrenciId == ogrenciId && !o.IsDeleted)
 .OrderByDescending(o => o.OdemeTarihi)
                .ToListAsync();
        }

      public async Task<OgrenciOdemeTakvimi?> GetOdemeByIdAsync(long id)
   {
 return await _context.OgrenciOdemeTakvimi
    .Include(o => o.Ogrenci)
              .Where(o => !o.IsDeleted)
         .FirstOrDefaultAsync(o => o.Id == id);
  }

        public async Task<OgrenciOdemeTakvimi> AddOdemeAsync(OgrenciOdemeTakvimi odeme)
        {
       odeme.IsDeleted = false;
   odeme.Aktif = true;
  odeme.Version = 0;
 
if (!odeme.OdemeTarihi.HasValue)
       {
  odeme.OdemeTarihi = DateTime.Now;
}

       // Eðer TaksitTutari kaydedilmiþse ve ödenen tutar bu tutara eþit veya büyükse "Ödendi" true
      if (odeme.TaksitTutari.HasValue && odeme.TaksitTutari.Value > 0)
   {
        if (odeme.OdenenTutar >= odeme.TaksitTutari.Value && odeme.OdenenTutar > 0)
       {
         odeme.Odendi = true;
       }
      }

       _context.OgrenciOdemeTakvimi.Add(odeme);
await _context.SaveChangesAsync();
    
   // Sonraki ödemelerin kalan borcunu güncelle
    await RecalculateKalanBorcForOgrenciAsync(odeme.OgrenciId);
    
         return odeme;
        }

    public async Task<OgrenciOdemeTakvimi?> UpdateOdemeAsync(OgrenciOdemeTakvimi odeme)
        {
   var existingOdeme = await _context.OgrenciOdemeTakvimi
         .Where(o => !o.IsDeleted)
    .FirstOrDefaultAsync(o => o.Id == odeme.Id);

    if (existingOdeme == null)
            return null;

   existingOdeme.OdemeTarihi = odeme.OdemeTarihi;
    existingOdeme.OdenenTutar = odeme.OdenenTutar;
   existingOdeme.BorcTutari = odeme.BorcTutari;
         existingOdeme.Aciklama = odeme.Aciklama;
    existingOdeme.Version++;

     // Eðer TaksitTutari kaydedilmiþse ve ödenen tutar bu tutara eþit veya büyükse "Ödendi" true
  if (existingOdeme.TaksitTutari.HasValue && existingOdeme.TaksitTutari.Value > 0)
       {
       if (existingOdeme.OdenenTutar >= existingOdeme.TaksitTutari.Value && existingOdeme.OdenenTutar > 0)
 {
      existingOdeme.Odendi = true;
       }
  else
       {
    existingOdeme.Odendi = false;
     }
   }

       await _context.SaveChangesAsync();
 
     // Tüm ödemelerin kalan borcunu yeniden hesapla
    await RecalculateKalanBorcForOgrenciAsync(existingOdeme.OgrenciId);
            
      return existingOdeme;
        }

        public async Task<bool> DeleteOdemeAsync(long id)
      {
   var odeme = await _context.OgrenciOdemeTakvimi
    .Where(o => !o.IsDeleted)
         .FirstOrDefaultAsync(o => o.Id == id);
   
 if (odeme == null)
         return false;

       var ogrenciId = odeme.OgrenciId;
   
         // Soft delete
         odeme.IsDeleted = true;
      odeme.Aktif = false;
       await _context.SaveChangesAsync();
   
          // Kalan ödemelerin borcunu yeniden hesapla
            await RecalculateKalanBorcForOgrenciAsync(ogrenciId);
            
            return true;
   }

        public async Task<decimal> GetToplamOdenenTutarAsync(long ogrenciId)
        {
            return await _context.OgrenciOdemeTakvimi
            .Where(o => o.OgrenciId == ogrenciId && !o.IsDeleted)
   .SumAsync(o => o.OdenenTutar);
    }

  public async Task<decimal> GetKalanBorcAsync(long ogrenciId)
    {
  var sonOdeme = await _context.OgrenciOdemeTakvimi
        .Where(o => o.OgrenciId == ogrenciId && !o.IsDeleted)
   .OrderByDescending(o => o.OdemeTarihi)
        .ThenByDescending(o => o.Id)
           .FirstOrDefaultAsync();

      return sonOdeme?.BorcTutari ?? 0;
    }

    public async Task<decimal> GetToplamKalanBorcAsync()
    {
     // Aktif öðrencileri getir
        var ogrencilerWithData = await _context.Ogrenciler
            .Where(o => !o.IsDeleted && o.Aktif)
     .Select(o => o.Id)
            .ToListAsync();

        decimal toplamBorc = 0;

        foreach (var ogrenciId in ogrencilerWithData)
        {
            // Öðrencinin tüm ödenmemiþ taksitlerinin taksit tutarlarýný topla
    var odenmemisTaksitlerToplamý = await _context.OgrenciOdemeTakvimi
            .Where(o => o.OgrenciId == ogrenciId && 
        !o.IsDeleted && 
       !o.Odendi)  // Ödenmemiþ taksitler
 .SumAsync(o => o.TaksitTutari ?? 0);

            toplamBorc += odenmemisTaksitlerToplamý;
}

        return toplamBorc;
    }

    /// <summary>
    /// Öðrencinin tüm ödeme kayýtlarý için kalan borcu kronolojik sýrayla yeniden hesaplar
    /// </summary>
    public async Task RecalculateKalanBorcForOgrenciAsync(long ogrenciId)
    {
    // Öðrenciyi ve ödeme planýný getir
        var ogrenci = await _context.Ogrenciler
      .Include(o => o.OdemePlanlari)
       .FirstOrDefaultAsync(o => o.Id == ogrenciId && !o.IsDeleted);

    if (ogrenci == null)
            return;

     // Baþlangýç borcu (ödeme planýndan) - Ödeme planý silinmemiþse
        decimal baslangicBorc = 0;
        if (ogrenci.OdemePlanlari != null && !ogrenci.OdemePlanlari.IsDeleted)
        {
 baslangicBorc = ogrenci.OdemePlanlari.Tutar;
     }

      // Tüm ödemeleri tarihe göre sýrala (eski -> yeni) - Silinmemiþ kayýtlar
        var odemeler = await _context.OgrenciOdemeTakvimi
       .Where(o => o.OgrenciId == ogrenciId && !o.IsDeleted)
            .OrderBy(o => o.OdemeTarihi ?? DateTime.MaxValue)
            .ThenBy(o => o.Id)
            .ToListAsync();

        // Eðer hiç ödeme yoksa, iþlem yapma
 if (!odemeler.Any())
  return;

        decimal kalanBorc = baslangicBorc;

        // Her ödemeyi sýrayla iþle
        foreach (var odeme in odemeler)
  {
          // Bu ödeme yapýldýktan sonra kalan borç
kalanBorc = Math.Max(0, kalanBorc - odeme.OdenenTutar);
       
       // Kalan borcu güncelle
    odeme.BorcTutari = kalanBorc;
        }

        // Deðiþiklikleri kaydet
        await _context.SaveChangesAsync();
  }
    }
}
